<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /docs/asp-net-core-3x/README.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# ASP.NET Core 3.x and .NET 5

Starting ASP.NET Core 3.x ServiceComposer leverages the new Endpoints support to plugin into the request handling pipeline.
ServiceComposer can be added to existing or new ASP.NET Core projects, and to .NET Core console applications.

Add a reference to `ServiceComposer.AspNetCore` NuGet package and configure the `Startup` class like follows:

<!-- snippet: net-core-3x-sample-startup -->
<a id='snippet-net-core-3x-sample-startup'></a>
```cs
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddRouting();
        services.AddViewModelComposition();
    }

    public void Configure(IApplicationBuilder app, ILoggerFactory loggerFactory)
    {
        app.UseRouting();
        app.UseEndpoints(builder => builder.MapCompositionHandlers());
    }
}
```
<sup><a href='/src/Snippets.NetCore3x/Configuration/Startup.cs#L8-L23' title='Snippet source file'>snippet source</a> | <a href='#snippet-net-core-3x-sample-startup' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

> NOTE: To use a `Startup` class Generic Host support is required.

ServiceComposer uses regular ASP.NET Core attribute routing to configure routes for which composition support is required. For example, to enable composition support for the `/sample/{id}` route an handler like the following can be defined:

<!-- snippet: net-core-3x-sample-handler -->
<a id='snippet-net-core-3x-sample-handler'></a>
```cs
public class SampleHandler : ICompositionRequestsHandler
{
    [HttpGet("/sample/{id}")]
    public Task Handle(HttpRequest request)
    {
        return Task.CompletedTask;
    }
}
```
<sup><a href='/src/Snippets.NetCore3x/SampleHandler/SampleHandler.cs#L10-L19' title='Snippet source file'>snippet source</a> | <a href='#snippet-net-core-3x-sample-handler' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

## Authentication and Authorization

By virtue of leveraging ASP.NET Core 3.x Endpoints ServiceComposer automatically supports authentication and authorization metadata attributes to express authentication and authorization requirements on routes. For example, it's possible to use the `Authorize` attribute to specify that a handler requires authorization. The authorization process is the regular ASP.NET Core 3.x process and no special configuration is needed to plugin ServiceComposer:

<!-- snippet: net-core-3x-sample-handler-with-authorization -->
<a id='snippet-net-core-3x-sample-handler-with-authorization'></a>
```cs
public class SampleHandlerWithAuthorization : ICompositionRequestsHandler
{
    [Authorize]
    [HttpGet("/sample/{id}")]
    public Task Handle(HttpRequest request)
    {
        return Task.CompletedTask;
    }
}
```
<sup><a href='/src/Snippets.NetCore3x/SampleHandler/SampleHandler.cs#L21-L31' title='Snippet source file'>snippet source</a> | <a href='#snippet-net-core-3x-sample-handler-with-authorization' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

## Custom HTTP status codes in ASP.NET Core 3.x

The response status code can be set in requests handlers and it'll be honored by the composition pipeline. To set a custom response status code the following snippet can be used:

<!-- snippet: net-core-3x-sample-handler-with-custom-status-code -->
<a id='snippet-net-core-3x-sample-handler-with-custom-status-code'></a>
```cs
public class SampleHandlerWithCustomStatusCode : ICompositionRequestsHandler
{
    [HttpGet("/sample/{id}")]
    public Task Handle(HttpRequest request)
    {
        var response = request.HttpContext.Response;
        response.StatusCode = (int)HttpStatusCode.Forbidden;

        return Task.CompletedTask;
    }
}
```
<sup><a href='/src/Snippets.NetCore3x/SampleHandler/SampleHandler.cs#L33-L45' title='Snippet source file'>snippet source</a> | <a href='#snippet-net-core-3x-sample-handler-with-custom-status-code' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

NOTE: Requests handlers are executed in parallel in a non-deterministic way, setting the response code in more than one handler can have unpredictable effects.
