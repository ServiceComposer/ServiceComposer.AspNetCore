# Upgrade guide from v1.x to v2.0.0

<!-- toc -->
## Contents

  * [Target frameworks](#target-frameworks)
  * [ASP.Net Core endopints integration](#aspnet-core-endopints-integration)
  * [Composition handlers API changes](#composition-handlers-api-changes)
    * [IHandleRequests -> ICompositionRequestsHandler](#ihandlerequests---icompositionrequestshandler)
    * [IPublishCompositionEvents -> ICompositionEventsPublisher](#ipublishcompositionevents---icompositioneventspublisher)
    * [ISubscribeToCompositionEvents -> ICompositionEventsSubscriber](#isubscribetocompositionevents---icompositioneventssubscriber)
    * [IHandleRequestsErrors -> ICompositionErrorsHandler](#ihandlerequestserrors---icompositionerrorshandler)
  * [DynamicViewModel RaiseEvent -> ICompositionContext](#dynamicviewmodel-raiseevent---icompositioncontext)
  * [MapCompositionHandlers write support](#mapcompositionhandlers-write-support)
  * [IViewModelPreviewHandler Preview](#iviewmodelpreviewhandler-preview)
  * [Route matching](#route-matching)<!-- endToc -->

## Target frameworks

Starting with version 2.0.0 the `ServiceComposer.AspNetCore` package targets only the following frameworks

- net6.0
- net7.0

## ASP.Net Core endopints integration

ServiceComposer uses ASP.Net endpoints. The `RunCompositionGateway` API is deprecated in favor of explict ASP.Net endpoint configuration; Use the new endpoints mapping API:

<!-- snippet: run-composition-gateway-deprecation -->
<a id='snippet-run-composition-gateway-deprecation'></a>
```cs
public void Configure(IApplicationBuilder app, ILoggerFactory loggerFactory)
{
    app.UseRouting();
    app.UseEndpoints(builder => builder.MapCompositionHandlers());
}
```
<sup><a href='/src/Snippets/UpgradeGuides/1.x-to-2.0/UpgradeGuide.cs#L12-L18' title='Snippet source file'>snippet source</a> | <a href='#snippet-run-composition-gateway-deprecation' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

Extending the `IRouteBuilder` intrerface to map custom route is not anymore supported. Instead, use mapping attributes on composition handlers. See below for details about the composition handlers API.

## Composition handlers API changes

### IHandleRequests -> ICompositionRequestsHandler

### IPublishCompositionEvents -> ICompositionEventsPublisher

### ISubscribeToCompositionEvents -> ICompositionEventsSubscriber

### IHandleRequestsErrors -> ICompositionErrorsHandler

## DynamicViewModel RaiseEvent -> ICompositionContext

DynamicViewModel stopped imnplementing ICompositionContext

## MapCompositionHandlers write support

By default ServiceComposer responds only to HTTP `GET` requests, to enable write support, for example to handle `POST` requests, the following configuration can be used when adding ServiceComposer to the application:

<!-- snippet: enable-write-support -->
<a id='snippet-enable-write-support'></a>
```cs
public void ConfigureServices(IServiceCollection services)
{
    services.AddViewModelComposition(options => options.EnableWriteSupport());
}
```
<sup><a href='/src/Snippets/WriteSupport/EnableWriteSupport.cs#L8-L13' title='Snippet source file'>snippet source</a> | <a href='#snippet-enable-write-support' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

## IViewModelPreviewHandler Preview

## Route matching

When using composition over controllers route matching is now case insensitive by default. The previous behavior can be configured via the composition over controllers options:

<!-- snippet: composition-over-controllers-case-sensitive -->
<a id='snippet-composition-over-controllers-case-sensitive'></a>
```cs
public void ConfigureServices(IServiceCollection services)
{
    services.AddViewModelComposition(config =>
    {
        config.EnableCompositionOverControllers(useCaseInsensitiveRouteMatching: false);
    });
}
```
<sup><a href='/src/Snippets/UpgradeGuides/1.x-to-2.0/UpgradeGuide.cs#L23-L31' title='Snippet source file'>snippet source</a> | <a href='#snippet-composition-over-controllers-case-sensitive' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
